<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™</title>
    <!-- Material Icons å­—ä½“ -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://unpkg.com/mdui@2.0.3/mdui.css" rel="stylesheet">
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .mod-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mod-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            margin-top: -64px;
            padding-top: 100px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin: 40px 20px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 12px;
            margin: 20px;
            border: 1px solid #e9ecef;
        }
        
        .search-bar {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .mod-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            padding: 20px;
        }
        
        .tag-chip {
            margin: 2px;
            font-size: 12px;
        }
        
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .content-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        @media (max-width: 768px) {
            .hero-section {
                padding: 40px 20px;
                padding-top: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                margin: 20px;
                gap: 16px;
            }
            
            .mod-grid {
                grid-template-columns: 1fr;
                padding: 20px 0;
            }
            
            .filter-section {
                margin: 20px 0;
                padding: 16px;
            }
            
            .filter-section > div {
                flex-direction: column;
                align-items: stretch;
            }
            
            .fab-container {
                bottom: 16px;
                right: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .mod-grid {
                grid-template-columns: 1fr;
                padding: 0;
            }
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
            gap: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state mdui-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <mdui-top-app-bar>
        <mdui-button-icon icon="menu" onclick="toggleMenu()" title="èœå•"></mdui-button-icon>
        <div style="flex: 1;">æ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™</div>
        <mdui-button-icon icon="search" onclick="focusSearch()" title="æœç´¢"></mdui-button-icon>
        <mdui-button-icon icon="notifications" onclick="showNotifications()" title="é€šçŸ¥"></mdui-button-icon>
        <mdui-avatar src="https://picsum.photos/seed/avatar/40/40.jpg" onclick="showUserMenu()" title="ç”¨æˆ·èœå•"></mdui-avatar>
    </mdui-top-app-bar>

    <!-- ä¾§è¾¹èœå• -->
    <mdui-drawer id="sideMenu" close-on-overlay-click>
        <div style="padding: 20px;">
            <mdui-typography variant="headline-large" style="margin-bottom: 24px;">èœå•</mdui-typography>
            
            <mdui-list>
                <mdui-list-item onclick="navigateToHome()">
                    <mdui-icon slot="icon">home</mdui-icon>
                    é¦–é¡µ
                </mdui-list-item>
                <mdui-list-item onclick="navigateToAdmin()">
                    <mdui-icon slot="icon">admin_panel_settings</mdui-icon>
                    ç®¡ç†åå°
                </mdui-list-item>
                <mdui-list-item onclick="showAbout()">
                    <mdui-icon slot="icon">info</mdui-icon>
                    å…³äº
                </mdui-list-item>
            </mdui-list>
            
            <div style="margin-top: 32px;">
                <mdui-typography variant="title-medium" style="margin-bottom: 16px;">åˆ†ç±»æµè§ˆ</mdui-typography>
                <div id="menuCategories" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- åˆ†ç±»å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </mdui-drawer>

    <!-- é€šçŸ¥é¢æ¿ -->
    <mdui-dialog id="notificationDialog" headline="é€šçŸ¥">
        <div style="padding: 20px;">
            <div id="notificationList">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <mdui-icon style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">notifications_none</mdui-icon>
                    <mdui-typography>æš‚æ— æ–°é€šçŸ¥</mdui-typography>
                </div>
            </div>
        </div>
        <mdui-button slot="action" onclick="closeNotifications()">å…³é—­</mdui-button>
    </mdui-dialog>

    <!-- ç”¨æˆ·èœå• -->
    <mdui-dialog id="userMenuDialog" headline="ç”¨æˆ·èœå•">
        <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <mdui-avatar src="https://picsum.photos/seed/avatar/80/80.jpg" style="width: 80px; height: 80px; margin-bottom: 12px;"></mdui-avatar>
                <mdui-typography variant="title-medium">æ¸¸å®¢ç”¨æˆ·</mdui-typography>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <mdui-button onclick="goToFavorites()" icon="favorite" style="justify-content: flex-start;">
                    æˆ‘çš„æ”¶è—
                </mdui-button>
                <mdui-button onclick="goToUploads()" icon="upload" style="justify-content: flex-start;">
                    æˆ‘çš„ä¸Šä¼ 
                </mdui-button>
                <mdui-button onclick="showSettings()" icon="settings" style="justify-content: flex-start;">
                    è®¾ç½®
                </mdui-button>
                <mdui-button onclick="goToAdmin()" icon="admin_panel_settings" style="justify-content: flex-start;">
                    ç®¡ç†åå°
                </mdui-button>
            </div>
        </div>
        <mdui-button slot="action" onclick="closeUserMenu()">å…³é—­</mdui-button>
    </mdui-dialog>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main style="margin-top: 64px;">
        <!-- Hero åŒºåŸŸ -->
        <section class="hero-section">
            <mdui-typography variant="headline-large" style="margin-bottom: 16px;">
                å‘ç°ç²¾å½©æ¸¸æˆæ¨¡ç»„
            </mdui-typography>
            <mdui-typography variant="title-medium" style="margin-bottom: 32px; opacity: 0.9;">
                æ¢ç´¢ã€åˆ†äº«ã€ä¸‹è½½æ¥è‡ªå…¨çƒåˆ›ä½œè€…çš„æ¸¸æˆæ¨¡ç»„
            </mdui-typography>
            
            <!-- æœç´¢æ  -->
            <div class="search-bar">
                <mdui-text-field id="searchInput" placeholder="æœç´¢æ¨¡ç»„..." icon="search" style="width: 100%;">
                </mdui-text-field>
            </div>
        </section>

        <!-- ç»Ÿè®¡æ•°æ® -->
        <section style="padding: 40px 20px;">
            <div class="stats-grid">
                <mdui-card>
                    <div style="padding: 20px; text-align: center;">
                        <mdui-typography variant="display-small" id="totalMods">0</mdui-typography>
                        <mdui-typography variant="body-large">æ¨¡ç»„æ€»æ•°</mdui-typography>
                    </div>
                </mdui-card>
                <mdui-card>
                    <div style="padding: 20px; text-align: center;">
                        <mdui-typography variant="display-small" id="totalDownloads">0</mdui-typography>
                        <mdui-typography variant="body-large">æ€»ä¸‹è½½é‡</mdui-typography>
                    </div>
                </mdui-card>
                <mdui-card>
                    <div style="padding: 20px; text-align: center;">
                        <mdui-typography variant="display-small" id="totalGames">0</mdui-typography>
                        <mdui-typography variant="body-large">æ”¯æŒæ¸¸æˆ</mdui-typography>
                    </div>
                </mdui-card>
            </div>
        </section>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <section style="padding: 0 20px;">
            <div class="filter-section">
                <mdui-typography variant="headline-small" style="margin-bottom: 16px;">ç­›é€‰æ¡ä»¶</mdui-typography>
                
                <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                    <mdui-select id="gameFilter" placeholder="é€‰æ‹©æ¸¸æˆ">
                        <mdui-menu-item value="">æ‰€æœ‰æ¸¸æˆ</mdui-menu-item>
                    </mdui-select>
                    
                    <mdui-select id="tagFilter" placeholder="é€‰æ‹©æ ‡ç­¾">
                        <mdui-menu-item value="">æ‰€æœ‰æ ‡ç­¾</mdui-menu-item>
                    </mdui-select>
                    
                    <mdui-button onclick="clearFilters()">æ¸…é™¤ç­›é€‰</mdui-button>
                </div>
            </div>
        </section>

        <!-- ç®¡ç†åŠŸèƒ½åŒºåŸŸ -->
        <section style="padding: 20px;">
            <mdui-typography variant="headline-small" style="margin-bottom: 20px;">ç®¡ç†åŠŸèƒ½</mdui-typography>
            
            <div class="filter-section">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <mdui-card onclick="exportData()" style="cursor: pointer;">
                        <div style="padding: 20px; text-align: center;">
                            <mdui-icon style="font-size: 48px; margin-bottom: 12px;">download</mdui-icon>
                            <mdui-typography variant="title-medium">å¯¼å‡ºæ•°æ®</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">å¤‡ä»½æ‰€æœ‰æ¨¡ç»„æ•°æ®</mdui-typography>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="showImportDialog()" style="cursor: pointer;">
                        <div style="padding: 20px; text-align: center;">
                            <mdui-icon style="font-size: 48px; margin-bottom: 12px;">upload</mdui-icon>
                            <mdui-typography variant="title-medium">å¯¼å…¥æ•°æ®</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">ä»æ–‡ä»¶æ¢å¤æ•°æ®</mdui-typography>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="clearCache()" style="cursor: pointer;">
                        <div style="padding: 20px; text-align: center;">
                            <mdui-icon style="font-size: 48px; margin-bottom: 12px;">cleaning_services</mdui-icon>
                            <mdui-typography variant="title-medium">æ¸…ç†ç¼“å­˜</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">æ¸…ç†ä¸´æ—¶æ–‡ä»¶</mdui-typography>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="showStats()" style="cursor: pointer;">
                        <div style="padding: 20px; text-align: center;">
                            <mdui-icon style="font-size: 48px; margin-bottom: 12px;">analytics</mdui-icon>
                            <mdui-typography variant="title-medium">ç»Ÿè®¡ä¿¡æ¯</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</mdui-typography>
                        </div>
                    </mdui-card>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆåˆ†åŒº -->
        <section style="padding: 20px;">
            <mdui-typography variant="headline-large" style="margin-bottom: 32px; text-align: center;">
                çƒ­é—¨æ¸¸æˆåˆ†åŒº
            </mdui-typography>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                <div onclick="filterByGame('Minecraft')" style="cursor: pointer; text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-radius: 12px; transition: transform 0.2s;">
                    <mdui-icon style="font-size: 48px; margin-bottom: 12px;">games</mdui-icon>
                    <mdui-typography variant="title-medium">Minecraft</mdui-typography>
                </div>
                <div onclick="filterByGame('Cyberpunk 2077')" style="cursor: pointer; text-align: center; padding: 20px; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; border-radius: 12px; transition: transform 0.2s;">
                    <mdui-icon style="font-size: 48px; margin-bottom: 12px;">sports_esports</mdui-icon>
                    <mdui-typography variant="title-medium">Cyberpunk 2077</mdui-typography>
                </div>
                <div onclick="filterByGame('Stardew Valley')" style="cursor: pointer; text-align: center; padding: 20px; background: linear-gradient(135deg, #E91E63, #C2185B); color: white; border-radius: 12px; transition: transform 0.2s;">
                    <mdui-icon style="font-size: 48px; margin-bottom: 12px;">grass</mdui-icon>
                    <mdui-typography variant="title-medium">Stardew Valley</mdui-typography>
                </div>
                <div onclick="filterByGame('Terraria')" style="cursor: pointer; text-align: center; padding: 20px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; border-radius: 12px; transition: transform 0.2s;">
                    <mdui-icon style="font-size: 48px; margin-bottom: 12px;">landscape</mdui-icon>
                    <mdui-typography variant="title-medium">Terraria</mdui-typography>
                </div>
            </div>
            
            <div style="text-align: center; margin: 32px 0;">
                <mdui-typography variant="headline-medium">æ›´å¤šæ¸¸æˆï¼Œæ•¬è¯·æœŸå¾…</mdui-typography>
            </div>
        </section>

        <!-- FNFæ¨¡ç»„ä¸“åŒº -->
        <section style="padding: 20px; background: linear-gradient(135deg, #673AB7, #512DA8); color: white; border-radius: 12px; margin-bottom: 40px;">
            <div style="text-align: center; padding: 40px 20px;">
                <mdui-typography variant="headline-large" style="margin-bottom: 16px;">
                    Friday Night Funkin' æ¨¡ç»„ä¸“åŒº
                </mdui-typography>
                <mdui-typography variant="title-medium" style="margin-bottom: 32px; opacity: 0.9;">
                    ç²¾é€‰æœ€çƒ­é—¨çš„FNFæ¨¡ç»„ï¼Œè®©ä½ çš„èŠ‚å¥æ¸¸æˆæ›´åŠ ç²¾å½©ï¼
                </mdui-typography>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <mdui-card onclick="viewExternalMod('https://gamebanana.com/mods/160846')" style="cursor: pointer;">
                        <div style="position: relative;">
                            <img src="https://picsum.photos/seed/vsimpostor/400/300.jpg" alt="VS Impostor V4" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" onerror="this.src='https://picsum.photos/seed/vsimpostor2/400/300.jpg'">
                            <div style="position: absolute; top: 8px; left: 8px; background: #FF5252; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ğŸ”¥ çƒ­é—¨
                            </div>
                            <div style="position: absolute; top: 8px; right: 8px; background: #673AB7; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                GameBanana
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <mdui-typography variant="title-medium">VS Impostor V4</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">å…¨æ–°è§’è‰²ï¼Œå…¨æ–°ä½“éªŒ</mdui-typography>
                            <div style="margin-top: 12px;">
                                <span style="color: #666; font-size: 14px;">ğŸ“¥ 15.2ä¸‡ â€¢ â¤ï¸ 8.9åƒ</span>
                            </div>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="viewExternalMod('https://gamebanana.com/mods/199938')" style="cursor: pointer;">
                        <div style="position: relative;">
                            <img src="https://picsum.photos/seed/crazymod/400/300.jpg" alt="Crazy Mod" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" onerror="this.src='https://picsum.photos/seed/crazymod2/400/300.jpg'">
                            <div style="position: absolute; top: 8px; left: 8px; background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ğŸµ éŸ³ä¹
                            </div>
                            <div style="position: absolute; top: 8px; right: 8px; background: #673AB7; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                GameBanana
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <mdui-typography variant="title-medium">Crazy Mod</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">éŸ³ä¹èŠ‚å¥æ¨¡ç»„</mdui-typography>
                            <div style="margin-top: 12px;">
                                <span style="color: #666; font-size: 14px;">ğŸ“¥ 12.8ä¸‡ â€¢ â¤ï¸ 6.2åƒ</span>
                            </div>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="viewExternalMod('https://gamebanana.com/mods/199938')" style="cursor: pointer;">
                        <div style="position: relative;">
                            <img src="https://picsum.photos/seed/kadeengine/400/300.jpg" alt="Kade Engine" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" onerror="this.src='https://picsum.photos/seed/kadeengine2/400/300.jpg'">
                            <div style="position: absolute; top: 8px; left: 8px; background: #2196F3; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ğŸ® å¼•æ“
                            </div>
                            <div style="position: absolute; top: 8px; right: 8px; background: #673AB7; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                GameBanana
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <mdui-typography variant="title-medium">Kade Engine</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">æ¸¸æˆå¼•æ“æ¨¡ç»„</mdui-typography>
                            <div style="margin-top: 12px;">
                                <span style="color: #666; font-size: 14px;">ğŸ“¥ 9.6ä¸‡ â€¢ â¤ï¸ 4.8åƒ</span>
                            </div>
                        </div>
                    </mdui-card>
                    
                    <mdui-card onclick="openGameBananaImport(3827)" style="cursor: pointer;">
                        <div style="position: relative;">
                            <img src="https://picsum.photos/seed/catmod/400/300.jpg" alt="Cat Mod" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" onerror="this.src='https://picsum.photos/seed/catmod2/400/300.jpg'">
                            <div style="position: absolute; top: 8px; left: 8px; background: #FF9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                ğŸ± çŒ«å’ª
                            </div>
                            <div style="position: absolute; top: 8px; right: 8px; background: #9C27B0; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                GameBanana
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <mdui-typography variant="title-medium">Cat Mod</mdui-typography>
                            <mdui-typography variant="body-small" color="secondary">å¯çˆ±çš„çŒ«å’ªä¸»é¢˜æ¨¡ç»„</mdui-typography>
                            <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #666; font-size: 14px;">ğŸ“¥ 8.4ä¸‡ â€¢ â¤ï¸ 3.2åƒ</span>
                                <mdui-button variant="outlined" size="small" onclick="event.stopPropagation(); openGameBananaImport(3827)">å¯¼å…¥</mdui-button>
                            </div>
                        </div>
                    </mdui-card>
                </div>
            </div>
        </section>

        <!-- æ¨¡ç»„åˆ—è¡¨ -->
        <section style="padding: 20px;">
            <mdui-typography variant="headline-small" style="margin-bottom: 20px;">çƒ­é—¨æ¨¡ç»„</mdui-typography>
            <div id="modsGrid" class="mod-grid">
                <!-- æ¨¡ç»„å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
    </main>

    <!-- ä¸Šä¼ æ¨¡ç»„æ‚¬æµ®æŒ‰é’® -->
    <div class="fab-container">
        <mdui-fab icon="add" extended onclick="openUploadDialog()">
            ä¸Šä¼ æ¨¡ç»„
        </mdui-fab>
    </div>

    <!-- ä¸Šä¼ æ¨¡ç»„å¯¹è¯æ¡† -->
    <mdui-dialog id="uploadDialog" headline="ä¸Šä¼ æ–°æ¨¡ç»„">
        <div style="padding: 20px;">
            <mdui-text-field id="modName" label="æ¨¡ç»„åç§°" required></mdui-text-field>
            <mdui-text-field id="modGame" label="æ‰€å±æ¸¸æˆ" required></mdui-text-field>
            <mdui-text-field id="modAuthor" label="ä½œè€…" required></mdui-text-field>
            <mdui-text-field id="modVersion" label="ç‰ˆæœ¬" value="1.0.0"></mdui-text-field>
            <mdui-text-field id="modDescription" label="æè¿°" rows="4" required></mdui-text-field>
            <mdui-text-field id="modTags" label="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)"></mdui-text-field>
            
            <div style="margin: 16px 0;">
                <mdui-typography>æ¨¡ç»„æ–‡ä»¶</mdui-typography>
                <input type="file" id="modFile" accept=".zip,.rar,.7z" style="margin-top: 8px;">
            </div>
            
            <div style="margin: 16px 0;">
                <mdui-typography>é¢„è§ˆå›¾ç‰‡</mdui-typography>
                <input type="file" id="modImage" accept="image/*" style="margin-top: 8px;">
            </div>
        </div>
        
        <mdui-button slot="action" onclick="closeUploadDialog()">å–æ¶ˆ</mdui-button>
        <mdui-button slot="action" onclick="uploadMod()" variant="filled">ä¸Šä¼ </mdui-button>
    </mdui-dialog>

    <script>
        let allMods = [];
        let allGames = [];
        let allTags = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async function() {
            await loadMods();
            await loadFilters();
            updateStats();
            renderMods(allMods);
            initMenuCategories(); // åˆå§‹åŒ–èœå•åˆ†ç±»
        });

        // åŠ è½½æ¨¡ç»„æ•°æ®
        async function loadMods() {
            try {
                const response = await fetch('/api/mods');
                allMods = await response.json();
            } catch (error) {
                console.error('åŠ è½½æ¨¡ç»„å¤±è´¥:', error);
                showSnackbar('åŠ è½½æ¨¡ç»„å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç­›é€‰å™¨æ•°æ®
        async function loadFilters() {
            try {
                const [gamesResponse, tagsResponse] = await Promise.all([
                    fetch('/api/games'),
                    fetch('/api/tags')
                ]);
                
                allGames = await gamesResponse.json();
                allTags = await tagsResponse.json();

                // å¡«å……æ¸¸æˆç­›é€‰å™¨
                const gameFilter = document.getElementById('gameFilter');
                allGames.forEach(game => {
                    const item = document.createElement('mdui-menu-item');
                    item.value = game;
                    item.textContent = game;
                    gameFilter.appendChild(item);
                });

                // å¡«å……æ ‡ç­¾ç­›é€‰å™¨
                const tagFilter = document.getElementById('tagFilter');
                allTags.forEach(tag => {
                    const item = document.createElement('mdui-menu-item');
                    item.value = tag;
                    item.textContent = tag;
                    tagFilter.appendChild(item);
                });
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰å™¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const totalMods = allMods.length;
            const totalDownloads = allMods.reduce((sum, mod) => sum + mod.downloads, 0);
            const totalGames = new Set(allMods.map(mod => mod.game)).size;

            document.getElementById('totalMods').textContent = totalMods;
            document.getElementById('totalDownloads').textContent = totalDownloads.toLocaleString();
            document.getElementById('totalGames').textContent = totalGames;
        }

        // æ¸²æŸ“æ¨¡ç»„åˆ—è¡¨
        function renderMods(mods) {
            const grid = document.getElementById('modsGrid');
            grid.innerHTML = '';

            mods.forEach(mod => {
                const card = document.createElement('mdui-card');
                card.className = 'mod-card';
                
                card.innerHTML = `
                    <div style="position: relative;">
                        <img src="${mod.image}" alt="${mod.name}" style="width: 100%; height: 200px; object-fit: cover;">
                            <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${mod.game}
                            </div>
                        </div>
                    <div style="padding: 16px;">
                        <mdui-typography variant="headline-small" style="margin-bottom: 8px;">${mod.name}</mdui-typography>
                        <mdui-typography variant="body-medium" style="color: #666; margin-bottom: 8px;">ä½œè€…: ${mod.author}</mdui-typography>
                        
                        <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px;">
                            ${mod.tags.map(tag => `<span class="tag-chip" style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${tag}</span>`).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 16px; color: #666; font-size: 14px;">
                                <span>ğŸ“¥ ${mod.downloads.toLocaleString()}</span>
                                <span>â¤ï¸ ${mod.likes}</span>
                                <span>ğŸ“… ${mod.createdAt}</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <mdui-button-icon icon="favorite" onclick="event.stopPropagation(); likeMod(${mod.id})" title="ç‚¹èµ"></mdui-button-icon>
                                <mdui-button-icon icon="visibility" onclick="event.stopPropagation(); viewModDetails(${mod.id})" title="æŸ¥çœ‹è¯¦æƒ…"></mdui-button-icon>
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', debounce(filterMods, 300));
        document.getElementById('gameFilter').addEventListener('change', filterMods);
        document.getElementById('tagFilter').addEventListener('change', filterMods);

        function filterMods() {
            const search = document.getElementById('searchInput').value;
            const game = document.getElementById('gameFilter').value;
            const tag = document.getElementById('tagFilter').value;

            let filtered = allMods;

            if (search) {
                filtered = filtered.filter(mod => 
                    mod.name.toLowerCase().includes(search.toLowerCase()) ||
                    mod.description.toLowerCase().includes(search.toLowerCase())
                );
            }

            if (game) {
                filtered = filtered.filter(mod => mod.game === game);
            }

            if (tag) {
                filtered = filtered.filter(mod => mod.tags.includes(tag));
            }

            renderMods(filtered);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('gameFilter').value = '';
            document.getElementById('tagFilter').value = '';
            renderMods(allMods);
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ç‚¹èµåŠŸèƒ½
        async function likeMod(id) {
            try {
                const response = await fetch(`/api/mods/${id}/like`, { method: 'POST' });
                const data = await response.json();
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const mod = allMods.find(m => m.id === id);
                if (mod) {
                    mod.likes = data.likes;
                    filterMods(); // é‡æ–°æ¸²æŸ“å½“å‰è§†å›¾
                    showSnackbar('ç‚¹èµæˆåŠŸï¼');
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                showSnackbar('ç‚¹èµå¤±è´¥', 'error');
            }
        }

        // æŸ¥çœ‹æ¨¡ç»„è¯¦æƒ…
        function viewModDetails(id) {
            window.location.href = `/mod.html?id=${id}`;
        }

        // æ‰“å¼€ä¸Šä¼ å¯¹è¯æ¡†
        function openUploadDialog() {
            document.getElementById('uploadDialog').open = true;
        }

        // å…³é—­ä¸Šä¼ å¯¹è¯æ¡†
        function closeUploadDialog() {
            document.getElementById('uploadDialog').open = false;
            // æ¸…ç©ºè¡¨å•
            document.getElementById('modName').value = '';
            document.getElementById('modGame').value = '';
            document.getElementById('modAuthor').value = '';
            document.getElementById('modVersion').value = '1.0.0';
            document.getElementById('modDescription').value = '';
            document.getElementById('modTags').value = '';
            document.getElementById('modFile').value = '';
            document.getElementById('modImage').value = '';
        }

        // ä¸Šä¼ æ¨¡ç»„
        async function uploadMod() {
            const formData = new FormData();
            formData.append('name', document.getElementById('modName').value);
            formData.append('game', document.getElementById('modGame').value);
            formData.append('author', document.getElementById('modAuthor').value);
            formData.append('version', document.getElementById('modVersion').value);
            formData.append('description', document.getElementById('modDescription').value);
            formData.append('tags', document.getElementById('modTags').value);
            
            const fileInput = document.getElementById('modFile');
            const imageInput = document.getElementById('modImage');
            
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }
            
            if (imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }

            try {
                const response = await fetch('/api/mods', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    closeUploadDialog();
                    showSnackbar('æ¨¡ç»„ä¸Šä¼ æˆåŠŸï¼');
                    await loadMods();
                    filterMods();
                    updateStats();
                } else {
                    showSnackbar('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¿…å¡«å­—æ®µ', 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showSnackbar('ä¸Šä¼ å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showSnackbar(message, type = 'success') {
            const snackbar = document.createElement('mdui-snackbar');
            snackbar.position = 'top';
            snackbar.message = message;
            
            if (type === 'error') {
                snackbar.style.setProperty('--mdui-color-snackbar-container', '#f44336');
            }
            
            document.body.appendChild(snackbar);
            snackbar.open = true;
            
            setTimeout(() => {
                document.body.removeChild(snackbar);
            }, 3000);
        }

        // ç®¡ç†åŠŸèƒ½
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const response = await fetch('/api/export');
                const data = await response.json();
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mods_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSnackbar('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showSnackbar('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºå¯¼å…¥å¯¹è¯æ¡†
        function showImportDialog() {
            const dialog = document.createElement('mdui-dialog');
            dialog.headline = 'å¯¼å…¥æ•°æ®';
            dialog.innerHTML = `
                <div style="padding: 20px;">
                    <mdui-typography variant="body-medium" style="margin-bottom: 16px;">
                        é€‰æ‹©è¦å¯¼å…¥çš„æ•°æ®æ–‡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
                    </mdui-typography>
                    <input type="file" id="importFile" accept=".json" style="width: 100%;">
                    <div style="margin-top: 12px; font-size: 12px; color: #666;">
                        æ³¨æ„ï¼šå¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ
                    </div>
                </div>
                <mdui-button slot="action" onclick="this.parentElement.close()">å–æ¶ˆ</mdui-button>
                <mdui-button slot="action" onclick="importData()" variant="filled">å¯¼å…¥</mdui-button>
            `;
            
            document.body.appendChild(dialog);
            dialog.open = true;
        }

        // å¯¼å…¥æ•°æ®
        async function importData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files[0]) {
                showSnackbar('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const data = JSON.parse(text);

                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showSnackbar('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    await loadMods();
                    await loadFilters();
                    updateStats();
                    renderMods(allMods);
                } else {
                    showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
            }
        }

        // æ¸…ç†ç¼“å­˜
        async function clearCache() {
            try {
                const response = await fetch('/api/clear-cache', { method: 'POST' });
                const result = await response.json();
                
                showSnackbar(`ç¼“å­˜æ¸…ç†å®Œæˆï¼æ¸…ç†äº† ${result.clearedItems} é¡¹`);
            } catch (error) {
                console.error('æ¸…ç†å¤±è´¥:', error);
                showSnackbar('æ¸…ç†å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        async function showStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const dialog = document.createElement('mdui-dialog');
                dialog.headline = 'è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯';
                dialog.style.width = '600px';
                
                dialog.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <mdui-typography variant="title-medium">æ¨¡ç»„ç»Ÿè®¡</mdui-typography>
                                <div style="margin-top: 12px;">
                                    <div>æ€»æ¨¡ç»„æ•°: ${stats.totalMods}</div>
                                    <div>æ€»ä¸‹è½½é‡: ${stats.totalDownloads.toLocaleString()}</div>
                                    <div>æ€»ç‚¹èµæ•°: ${stats.totalLikes}</div>
                                    <div>æ”¯æŒæ¸¸æˆ: ${stats.totalGames} æ¬¾</div>
                                </div>
                            </div>
                            <div>
                                <mdui-typography variant="title-medium">æ ‡ç­¾ç»Ÿè®¡</mdui-typography>
                                <div style="margin-top: 12px;">
                                    ${stats.topTags.map(tag => `
                                        <div>${tag.name}: ${tag.count} ä¸ªæ¨¡ç»„</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <mdui-typography variant="title-medium">çƒ­é—¨æ¸¸æˆ</mdui-typography>
                            <div style="margin-top: 12px;">
                                ${stats.topGames.map(game => `
                                    <div>${game.name}: ${game.mods} ä¸ªæ¨¡ç»„</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <mdui-button slot="action" onclick="this.parentElement.close()">å…³é—­</mdui-button>
                `;
                
                document.body.appendChild(dialog);
                dialog.open = true;
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
                showSnackbar('è·å–ç»Ÿè®¡å¤±è´¥', 'error');
            }
        }

        // å¯¼èˆªåŠŸèƒ½
        function toggleMenu() {
            const drawer = document.getElementById('sideMenu');
            drawer.open = !drawer.open;
        }

        function focusSearch() {
            document.getElementById('searchInput').focus();
        }

        function showNotifications() {
            document.getElementById('notificationDialog').open = true;
        }

        function closeNotifications() {
            document.getElementById('notificationDialog').open = false;
        }

        function showUserMenu() {
            document.getElementById('userMenuDialog').open = true;
        }

        function closeUserMenu() {
            document.getElementById('userMenuDialog').open = false;
        }

        function navigateToHome() {
            window.location.href = '/';
        }

        function navigateToAdmin() {
            window.location.href = '/admin.html';
        }

        function goToAdmin() {
            window.location.href = '/admin.html';
        }

        function goToFavorites() {
            showSnackbar('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­...');
            closeUserMenu();
        }

        function goToUploads() {
            showSnackbar('æˆ‘çš„ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...');
            closeUserMenu();
        }

        function showSettings() {
            showSnackbar('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
            closeUserMenu();
        }

        function showAbout() {
            const dialog = document.createElement('mdui-dialog');
            dialog.headline = 'å…³äºæ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™';
            dialog.innerHTML = `
                <div style="padding: 20px;">
                    <mdui-typography variant="body-medium" style="margin-bottom: 16px;">
                        æ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™ v1.0.0
                    </mdui-typography>
                    <mdui-typography variant="body-small" color="secondary" style="margin-bottom: 16px;">
                        ä¸€ä¸ªä¸“æ³¨äºæ¸¸æˆæ¨¡ç»„åˆ†äº«å’Œç®¡ç†çš„å¹³å°ï¼Œä¸ºç©å®¶å’Œæ¨¡ç»„ä½œè€…æä¾›ä¾¿æ·çš„æœåŠ¡ã€‚
                    </mdui-typography>
                    
                    <div style="margin-top: 24px;">
                        <mdui-typography variant="title-medium">ä¸»è¦åŠŸèƒ½</mdui-typography>
                        <ul style="margin-top: 12px; padding-left: 20px;">
                            <li>æ¨¡ç»„ä¸Šä¼ å’Œåˆ†äº«</li>
                            <li>æ¨¡ç»„æœç´¢å’Œç­›é€‰</li>
                            <li>ç‚¹èµå’Œè¯„è®ºç³»ç»Ÿ</li>
                            <li>æ•°æ®å¯¼å‡ºå’Œå¯¼å…¥</li>
                            <li>ç®¡ç†åå°ç³»ç»Ÿ</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 24px; text-align: center;">
                        <mdui-typography variant="body-small" color="secondary">
                            Â© 2024 æ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™. All rights reserved.
                        </mdui-typography>
                    </div>
                </div>
                <mdui-button slot="action" onclick="this.parentElement.close()">å…³é—­</mdui-button>
            `;
            
            document.body.appendChild(dialog);
            dialog.open = true;
        }

        // åˆå§‹åŒ–èœå•åˆ†ç±»
        function initMenuCategories() {
            const categoriesContainer = document.getElementById('menuCategories');
            allGames.forEach(game => {
                const categoryItem = document.createElement('div');
                categoryItem.style.cssText = 'padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s;';
                categoryItem.innerHTML = `
                    <mdui-typography variant="body-medium">${game}</mdui-typography>
                `;
                categoryItem.onclick = () => filterByGame(game);
                categoryItem.onmouseover = () => categoryItem.style.backgroundColor = '#f5f5f5';
                categoryItem.onmouseout = () => categoryItem.style.backgroundColor = 'transparent';
                categoriesContainer.appendChild(categoryItem);
            });
        }

        function filterByGame(game) {
            document.getElementById('gameFilter').value = game;
            filterMods();
            toggleMenu(); // å…³é—­èœå•
        }

        // GameBanana ç›¸å…³åŠŸèƒ½
        async function openGameBananaImport(categoryId) {
            try {
                const response = await fetch(`/api/gamebanana/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ modId: categoryId })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSnackbar('æˆåŠŸä» GameBanana å¯¼å…¥æ¨¡ç»„ï¼');
                    // åˆ·æ–°æ¨¡ç»„åˆ—è¡¨
                    await loadMods();
                    filterMods();
                    updateStats();
                } else {
                    showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
            }
        }

        // ä¿®å¤å¯¹è¯æ¡†å…³é—­åŠŸèƒ½
        function closeDialog(dialogId) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.open = false;
            }
        }

        function closeUploadDialog() {
            closeDialog('uploadDialog');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('modName').value = '';
            document.getElementById('modGame').value = '';
            document.getElementById('modAuthor').value = '';
            document.getElementById('modVersion').value = '1.0.0';
            document.getElementById('modDescription').value = '';
            document.getElementById('modTags').value = '';
            document.getElementById('modFile').value = '';
            document.getElementById('modImage').value = '';
        }

        function closeNotifications() {
            closeDialog('notificationDialog');
        }

        function closeUserMenu() {
            closeDialog('userMenuDialog');
        }

        // æŸ¥çœ‹å¤–éƒ¨æ¨¡ç»„
        function viewExternalMod(url) {
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const dialog = document.createElement('mdui-dialog');
            dialog.headline = 'å¤–éƒ¨æ¨¡ç»„';
            dialog.innerHTML = `
                <div style="padding: 20px;">
                    <mdui-typography variant="body-medium" style="margin-bottom: 16px;">
                        æ‚¨å³å°†è®¿é—® GameBanana ä¸Šçš„æ¨¡ç»„
                    </mdui-typography>
                    <mdui-typography variant="body-small" color="secondary" style="margin-bottom: 20px;">
                        è¿™ä¸ªæ¨¡ç»„æ‰˜ç®¡åœ¨ GameBanana å¹³å°ä¸Šï¼Œç‚¹å‡»"ç¡®å®š"å°†åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å®ƒã€‚
                    </mdui-typography>
                    
                    <div style="margin: 20px 0;">
                        <mdui-checkbox id="dontShowAgain">
                            ä¸å†æ˜¾ç¤ºæ­¤æç¤º
                        </mdui-checkbox>
                    </div>
                </div>
                <mdui-button slot="action" onclick="this.parentElement.close()">å–æ¶ˆ</mdui-button>
                <mdui-button slot="action" onclick="confirmExternalMod('${url}')" variant="filled">ç¡®å®š</mdui-button>
            `;
            
            document.body.appendChild(dialog);
            dialog.open = true;
            
            // æ·»åŠ ç¡®è®¤åŠŸèƒ½åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.confirmExternalMod = function(modUrl) {
                const dontShowAgain = document.getElementById('dontShowAgain').checked;
                if (dontShowAgain) {
                    localStorage.setItem('dontShowExternalModWarning', 'true');
                }
                
                dialog.close();
                window.open(modUrl, '_blank');
                
                // æ¸…ç†å…¨å±€å‡½æ•°
                delete window.confirmExternalMod;
            };
        }
    </script>
</body>
</html>
