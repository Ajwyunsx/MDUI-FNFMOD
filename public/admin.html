<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - æ¸¸æˆæ¨¡ç»„æ”¶å½•ç«™</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://unpkg.com/mdui@2.0.3/mdui.css" rel="stylesheet">
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .action-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .action-card:hover {
            transform: translateY(-4px);
        }
        .mod-list {
            margin-top: 20px;
        }
        .mod-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
        }
        .mod-item:last-child {
            border-bottom: none;
        }
        .mod-info {
            flex: 1;
        }
        .mod-actions {
            display: flex;
            gap: 8px;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginScreen">
        <div class="login-form">
            <mdui-typography variant="headline-large" style="text-align: center; margin-bottom: 32px;">
                ç®¡ç†å‘˜ç™»å½•
            </mdui-typography>
            <mdui-text-field id="adminUsername" label="ç”¨æˆ·å" style="width: 100%; margin-bottom: 16px;"></mdui-text-field>
            <mdui-text-field id="adminPassword" label="å¯†ç " type="password" style="width: 100%; margin-bottom: 24px;"></mdui-text-field>
            <mdui-button onclick="adminLogin()" variant="filled" style="width: 100%;">ç™»å½•</mdui-button>
        </div>
    </div>

    <!-- ç®¡ç†ç•Œé¢ -->
    <div id="adminScreen" class="hidden">
        <mdui-top-app-bar>
            <mdui-button-icon icon="menu"></mdui-button-icon>
            <div style="flex: 1;">ç®¡ç†åå°</div>
            <mdui-button-icon icon="logout" onclick="adminLogout()" title="é€€å‡ºç™»å½•"></mdui-button-icon>
        </mdui-top-app-bar>

        <div class="admin-container" style="margin-top: 64px;">
            <!-- ç»Ÿè®¡æ•°æ® -->
            <mdui-typography variant="headline-large" style="margin-bottom: 20px;">æ•°æ®æ¦‚è§ˆ</mdui-typography>
            <div class="stats-grid" id="adminStats">
                <!-- ç»Ÿè®¡æ•°æ®å°†åŠ¨æ€åŠ è½½ -->
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <mdui-typography variant="headline-large" style="margin: 40px 0 20px;">å¿«é€Ÿæ“ä½œ</mdui-typography>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <mdui-card class="action-card" onclick="showAddModDialog()">
                    <div style="padding: 20px; text-align: center;">
                        <mdui-icon style="font-size: 48px; margin-bottom: 12px; color: #4CAF50;">add_circle</mdui-icon>
                        <mdui-typography variant="title-medium">æ·»åŠ æ¨¡ç»„</mdui-typography>
                    </div>
                </mdui-card>
                
                <mdui-card class="action-card" onclick="exportAllData()">
                    <div style="padding: 20px; text-align: center;">
                        <mdui-icon style="font-size: 48px; margin-bottom: 12px; color: #2196F3;">download</mdui-icon>
                        <mdui-typography variant="title-medium">å¯¼å‡ºæ•°æ®</mdui-typography>
                    </div>
                </mdui-card>
                
                <mdui-card class="action-card" onclick="showImportDialog()">
                    <div style="padding: 20px; text-align: center;">
                        <mdui-icon style="font-size: 48px; margin-bottom: 12px; color: #FF9800;">upload</mdui-icon>
                        <mdui-typography variant="title-medium">å¯¼å…¥æ•°æ®</mdui-typography>
                    </div>
                </mdui-card>
                
                <mdui-card class="action-card" onclick="clearAllCache()">
                    <div style="padding: 20px; text-align: center;">
                        <mdui-icon style="font-size: 48px; margin-bottom: 12px; color: #F44336;">cleaning_services</mdui-icon>
                        <mdui-typography variant="title-medium">æ¸…ç†ç¼“å­˜</mdui-typography>
                    </div>
                </mdui-card>
            </div>

            <!-- æ¨¡ç»„ç®¡ç† -->
            <mdui-typography variant="headline-large" style="margin: 40px 0 20px;">æ¨¡ç»„ç®¡ç†</mdui-typography>
            <div style="margin-bottom: 16px;">
                <mdui-text-field id="searchMod" placeholder="æœç´¢æ¨¡ç»„..." icon="search" style="width: 300px;"></mdui-text-field>
                <mdui-button onclick="loadMods()" style="margin-left: 16px;">åˆ·æ–°</mdui-button>
            </div>
            
            <div class="mod-list" id="modList">
                <!-- æ¨¡ç»„åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æ¨¡ç»„å¯¹è¯æ¡† -->
    <mdui-dialog id="addModDialog" headline="æ·»åŠ æ–°æ¨¡ç»„">
        <div style="padding: 20px;">
            <mdui-text-field id="newModName" label="æ¨¡ç»„åç§°" required></mdui-text-field>
            <mdui-text-field id="newModGame" label="æ‰€å±æ¸¸æˆ" required></mdui-text-field>
            <mdui-text-field id="newModAuthor" label="ä½œè€…" required></mdui-text-field>
            <mdui-text-field id="newModVersion" label="ç‰ˆæœ¬" value="1.0.0"></mdui-text-field>
            <mdui-text-field id="newModDescription" label="æè¿°" rows="4" required></mdui-text-field>
            <mdui-text-field id="newModTags" label="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)"></mdui-text-field>
            <mdui-text-field id="newModDownloads" label="ä¸‹è½½é‡" type="number" value="0"></mdui-text-field>
            <mdui-text-field id="newModLikes" label="ç‚¹èµæ•°" type="number" value="0"></mdui-text-field>
            <mdui-text-field id="newModImage" label="å›¾ç‰‡URL"></mdui-text-field>
            <mdui-text-field id="newModFile" label="æ–‡ä»¶URL"></mdui-text-field>
        </div>
        <mdui-button slot="action" onclick="closeAddModDialog()">å–æ¶ˆ</mdui-button>
        <mdui-button slot="action" onclick="addNewMod()" variant="filled">æ·»åŠ </mdui-button>
    </mdui-dialog>

    <!-- ç¼–è¾‘æ¨¡ç»„å¯¹è¯æ¡† -->
    <mdui-dialog id="editModDialog" headline="ç¼–è¾‘æ¨¡ç»„">
        <div style="padding: 20px;">
            <input type="hidden" id="editModId">
            <mdui-text-field id="editModName" label="æ¨¡ç»„åç§°" required></mdui-text-field>
            <mdui-text-field id="editModGame" label="æ‰€å±æ¸¸æˆ" required></mdui-text-field>
            <mdui-text-field id="editModAuthor" label="ä½œè€…" required></mdui-text-field>
            <mdui-text-field id="editModVersion" label="ç‰ˆæœ¬"></mdui-text-field>
            <mdui-text-field id="editModDescription" label="æè¿°" rows="4" required></mdui-text-field>
            <mdui-text-field id="editModTags" label="æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)"></mdui-text-field>
            <mdui-text-field id="editModDownloads" label="ä¸‹è½½é‡" type="number"></mdui-text-field>
            <mdui-text-field id="editModLikes" label="ç‚¹èµæ•°" type="number"></mdui-text-field>
            <mdui-text-field id="editModImage" label="å›¾ç‰‡URL"></mdui-text-field>
            <mdui-text-field id="editModFile" label="æ–‡ä»¶URL"></mdui-text-field>
        </div>
        <mdui-button slot="action" onclick="closeEditModDialog()">å–æ¶ˆ</mdui-button>
        <mdui-button slot="action" onclick="updateMod()" variant="filled">ä¿å­˜</mdui-button>
    </mdui-dialog>

    <script>
        let currentMods = [];
        let editingModId = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminScreen').classList.remove('hidden');
                loadAdminStats();
                loadMods();
            }
        }

        // ç®¡ç†å‘˜ç™»å½•
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                showSnackbar('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('adminToken', data.token);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminScreen').classList.remove('hidden');
                    loadAdminStats();
                    loadMods();
                    showSnackbar('ç™»å½•æˆåŠŸï¼');
                } else {
                    showSnackbar('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showSnackbar('ç™»å½•å¤±è´¥', 'error');
            }
        }

        // ç®¡ç†å‘˜é€€å‡º
        function adminLogout() {
            localStorage.removeItem('adminToken');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            showSnackbar('å·²é€€å‡ºç™»å½•');
        }

        // åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡
        async function loadAdminStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('adminStats').innerHTML = `
                    <mdui-card>
                        <div style="padding: 20px; text-align: center;">
                            <mdui-typography variant="display-small">${stats.totalMods}</mdui-typography>
                            <mdui-typography variant="body-large">æ¨¡ç»„æ€»æ•°</mdui-typography>
                        </div>
                    </mdui-card>
                    <mdui-card>
                        <div style="padding: 20px; text-align: center;">
                            <mdui-typography variant="display-small">${stats.totalDownloads.toLocaleString()}</mdui-typography>
                            <mdui-typography variant="body-large">æ€»ä¸‹è½½é‡</mdui-typography>
                        </div>
                    </mdui-card>
                    <mdui-card>
                        <div style="padding: 20px; text-align: center;">
                            <mdui-typography variant="display-small">${stats.totalLikes}</mdui-typography>
                            <mdui-typography variant="body-large">æ€»ç‚¹èµæ•°</mdui-typography>
                        </div>
                    </mdui-card>
                    <mdui-card>
                        <div style="padding: 20px; text-align: center;">
                            <mdui-typography variant="display-small">${stats.totalGames}</mdui-typography>
                            <mdui-typography variant="body-large">æ”¯æŒæ¸¸æˆ</mdui-typography>
                        </div>
                    </mdui-card>
                `;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ¨¡ç»„åˆ—è¡¨
        async function loadMods() {
            try {
                const response = await fetch('/api/mods');
                currentMods = await response.json();
                renderModList();
            } catch (error) {
                console.error('åŠ è½½æ¨¡ç»„å¤±è´¥:', error);
                showSnackbar('åŠ è½½æ¨¡ç»„å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“æ¨¡ç»„åˆ—è¡¨
        function renderModList() {
            const searchTerm = document.getElementById('searchMod').value.toLowerCase();
            const filteredMods = currentMods.filter(mod => 
                mod.name.toLowerCase().includes(searchTerm) ||
                mod.game.toLowerCase().includes(searchTerm)
            );

            const modList = document.getElementById('modList');
            modList.innerHTML = '';

            if (filteredMods.length === 0) {
                modList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æ²¡æœ‰æ‰¾åˆ°æ¨¡ç»„</div>';
                return;
            }

            filteredMods.forEach(mod => {
                const modItem = document.createElement('div');
                modItem.className = 'mod-item';
                modItem.innerHTML = `
                    <div class="mod-info">
                        <mdui-typography variant="title-medium">${mod.name}</mdui-typography>
                        <mdui-typography variant="body-small" color="secondary">${mod.game} â€¢ ${mod.author} â€¢ v${mod.version}</mdui-typography>
                        <div style="margin-top: 8px;">
                            <span style="color: #666; font-size: 14px;">ğŸ“¥ ${mod.downloads} â€¢ â¤ï¸ ${mod.likes}</span>
                        </div>
                    </div>
                    <div class="mod-actions">
                        <mdui-button-icon icon="edit" onclick="showEditModDialog(${mod.id})" title="ç¼–è¾‘"></mdui-button-icon>
                        <mdui-button-icon icon="delete" onclick="deleteMod(${mod.id})" title="åˆ é™¤" style="color: #f44336;"></mdui-button-icon>
                    </div>
                `;
                modList.appendChild(modItem);
            });
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡ç»„å¯¹è¯æ¡†
        function showAddModDialog() {
            document.getElementById('addModDialog').open = true;
        }

        // å…³é—­æ·»åŠ æ¨¡ç»„å¯¹è¯æ¡†
        function closeAddModDialog() {
            document.getElementById('addModDialog').open = false;
            clearAddModForm();
        }

        // æ¸…ç©ºæ·»åŠ æ¨¡ç»„è¡¨å•
        function clearAddModForm() {
            document.getElementById('newModName').value = '';
            document.getElementById('newModGame').value = '';
            document.getElementById('newModAuthor').value = '';
            document.getElementById('newModVersion').value = '1.0.0';
            document.getElementById('newModDescription').value = '';
            document.getElementById('newModTags').value = '';
            document.getElementById('newModDownloads').value = '0';
            document.getElementById('newModLikes').value = '0';
            document.getElementById('newModImage').value = '';
            document.getElementById('newModFile').value = '';
        }

        // æ·»åŠ æ–°æ¨¡ç»„
        async function addNewMod() {
            const modData = {
                name: document.getElementById('newModName').value,
                game: document.getElementById('newModGame').value,
                author: document.getElementById('newModAuthor').value,
                version: document.getElementById('newModVersion').value,
                description: document.getElementById('newModDescription').value,
                tags: document.getElementById('newModTags').value,
                downloads: parseInt(document.getElementById('newModDownloads').value) || 0,
                likes: parseInt(document.getElementById('newModLikes').value) || 0,
                image: document.getElementById('newModImage').value || `https://picsum.photos/seed/mod${Date.now()}/400/300.jpg`,
                fileUrl: document.getElementById('newModFile').value || '',
                createdAt: new Date().toISOString().split('T')[0]
            };

            try {
                const response = await fetch('/api/admin/mods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(modData)
                });

                if (response.ok) {
                    closeAddModDialog();
                    loadMods();
                    loadAdminStats();
                    showSnackbar('æ¨¡ç»„æ·»åŠ æˆåŠŸï¼');
                } else {
                    showSnackbar('æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥:', error);
                showSnackbar('æ·»åŠ å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡ç»„å¯¹è¯æ¡†
        function showEditModDialog(modId) {
            const mod = currentMods.find(m => m.id === modId);
            if (!mod) return;

            document.getElementById('editModId').value = mod.id;
            document.getElementById('editModName').value = mod.name;
            document.getElementById('editModGame').value = mod.game;
            document.getElementById('editModAuthor').value = mod.author;
            document.getElementById('editModVersion').value = mod.version;
            document.getElementById('editModDescription').value = mod.description;
            document.getElementById('editModTags').value = mod.tags.join(', ');
            document.getElementById('editModDownloads').value = mod.downloads;
            document.getElementById('editModLikes').value = mod.likes;
            document.getElementById('editModImage').value = mod.image;
            document.getElementById('editModFile').value = mod.fileUrl;

            document.getElementById('editModDialog').open = true;
        }

        // å…³é—­ç¼–è¾‘æ¨¡ç»„å¯¹è¯æ¡†
        function closeEditModDialog() {
            document.getElementById('editModDialog').open = false;
        }

        // æ›´æ–°æ¨¡ç»„
        async function updateMod() {
            const modId = parseInt(document.getElementById('editModId').value);
            const modData = {
                name: document.getElementById('editModName').value,
                game: document.getElementById('editModGame').value,
                author: document.getElementById('editModAuthor').value,
                version: document.getElementById('editModVersion').value,
                description: document.getElementById('editModDescription').value,
                tags: document.getElementById('editModTags').value.split(',').map(tag => tag.trim()),
                downloads: parseInt(document.getElementById('editModDownloads').value) || 0,
                likes: parseInt(document.getElementById('editModLikes').value) || 0,
                image: document.getElementById('editModImage').value,
                fileUrl: document.getElementById('editModFile').value
            };

            try {
                const response = await fetch(`/api/admin/mods/${modId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(modData)
                });

                if (response.ok) {
                    closeEditModDialog();
                    loadMods();
                    loadAdminStats();
                    showSnackbar('æ¨¡ç»„æ›´æ–°æˆåŠŸï¼');
                } else {
                    showSnackbar('æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
                showSnackbar('æ›´æ–°å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤æ¨¡ç»„
        async function deleteMod(modId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            try {
                const response = await fetch(`/api/admin/mods/${modId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                if (response.ok) {
                    loadMods();
                    loadAdminStats();
                    showSnackbar('æ¨¡ç»„åˆ é™¤æˆåŠŸï¼');
                } else {
                    showSnackbar('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showSnackbar('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        function exportAllData() {
            window.location.href = '/api/export?token=' + localStorage.getItem('adminToken');
        }

        // æ˜¾ç¤ºå¯¼å…¥å¯¹è¯æ¡†
        function showImportDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    const response = await fetch('/api/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        loadMods();
                        loadAdminStats();
                        showSnackbar('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showSnackbar('å¯¼å…¥å¤±è´¥', 'error');
                }
            };
            input.click();
        }

        // æ¸…ç†æ‰€æœ‰ç¼“å­˜
        async function clearAllCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

            try {
                const response = await fetch('/api/clear-cache', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    }
                });

                const result = await response.json();
                showSnackbar(`ç¼“å­˜æ¸…ç†å®Œæˆï¼æ¸…ç†äº† ${result.clearedItems} é¡¹`);
            } catch (error) {
                console.error('æ¸…ç†å¤±è´¥:', error);
                showSnackbar('æ¸…ç†å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showSnackbar(message, type = 'success') {
            const snackbar = document.createElement('mdui-snackbar');
            snackbar.position = 'top';
            snackbar.message = message;
            
            if (type === 'error') {
                snackbar.style.setProperty('--mdui-color-snackbar-container', '#f44336');
            }
            
            document.body.appendChild(snackbar);
            snackbar.open = true;
            
            setTimeout(() => {
                document.body.removeChild(snackbar);
            }, 3000);
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchMod')?.addEventListener('input', renderModList);

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>
